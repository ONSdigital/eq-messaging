---
- hosts: localhost
  connection: local
  gather_facts: true

  tasks:
   - name: Provision a set of instances
     ec2:
         key_name: my-key-pair
         group: my-security-group
         instance_type: t2.small
         image: ami-47a23a30
         wait: true
         exact_count: 2
         region: eu-west-1
         count_tag:
            Name: Rabbit
         instance_tags:
            Name: Rabbit MQ
     register: ec2

   - name: Add all instance public IPs to host group
     add_host: hostname={{ item.public_ip }} groups=ec2hosts
     with_items: ec2.instances

   - name: Wait for SSH to come up
     local_action: wait_for host={{ item.public_ip }} port=22 delay=60 timeout=320 state=started
     with_items: ec2.instances

- hosts: ec2hosts
  sudo: yes
  user: ubuntu
  gather_facts: true

  tasks:
   - name: Change hostname to rabbit mq
     hostname: name=rabbitmq

   - name: Create rabbitq source  file
     command: sudo touch /etc/apt/sources.list.d/rabbitmq.list

   - name: Add write permissions to source file
     command: sudo chmod a+w /etc/apt/sources.list.d/rabbitmq.list

   - name: Cat Debian resource location to file
     command: sudo echo 'deb http://www.rabbitmq.com/debian/ testing main' > /etc/apt/sources.list.d/rabbitmq.list

   - name: Remove write permissions
     command: sudo chmod a-w /etc/apt/sources.list.d/rabbitmq.list

   - name: Get the public key for rabbit mq repo
     command: sudo curl https://www.rabbitmq.com/rabbitmq-signing-key-public.asc -o /tmp/rabbitmq-signing-key-public.asc

   - name: Add the public key
     command: sudo apt-key add /tmp/rabbitmq-signing-key-public.asc

   - name: Delete the public key
     command: sudo rm /tmp/rabbitmq-signing-key-public.asc

   - name: apt-get update
     command: sudo apt-get -qy update

   - name: Install RabbitMQ
     command: sudo apt-get -qy install rabbitmq-server

  post_tasks:
   - name: Add users
     command: sudo rabbitmqctl add_user survey_runner changeit

   - name: Set Permissions
     command: sudo rabbitmqctl set_permissions survey_runner '.*' '.*' '.*'

   - name: Create the rabbit env conf file
     command: sudo touch /etc/rabbitmq/rabbitmq-env.conf
   
   - name: Change permission
     command: sudo chmod a+w /etc/rabbitmq/rabbitmq-env.conf

   - name: Set use long name to true
     command: sudo echo 'RABBITMQ_USE_LONGNAME=true' > /etc/rabbitmq/rabbitmq-env.conf

   - name: Change permission back
     command: sudo chmod a-w /etc/rabbitmq/rabbitmq-env.conf
